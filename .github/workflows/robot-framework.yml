name: Robot Python Regression Tests

on:
  workflow_dispatch:
    inputs:
      runner:
        description: "Which test runner to execute?"
        required: true
        default: "ALL-LOBS"
        type: choice
        options:
          - ALL-LOBS
          - AE
          - BR
          - CE
          - Cyber
          - IA
          - KNR
          - MGMT-LIAB
          - ML-PRIVATE
          - Raven
          - RE
          - StorageTank
          - Alternus
          - TMS
          - TMS-BR
          - TMS-Cyber
          - TMS-MGMT-Non-Profit
          - TMS-MGMT-Pvt
          - TMS-REO
          - TMS-SAE
          - UW-RE
jobs:
  robot-tests:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      # Reliable Allure install for Windows runner
      - name: Install Allure CLI (Windows)
        shell: pwsh
        run: |
          $allureVersion = "2.27.0"
          $zip = "allure-$allureVersion.zip"
          $url = "https://github.com/allure-framework/allure2/releases/download/$allureVersion/allure-$allureVersion.zip"

          Invoke-WebRequest -Uri $url -OutFile $zip
          Expand-Archive -Path $zip -DestinationPath .
          Add-Content $env:GITHUB_PATH "$PWD\allure-$allureVersion\bin"

      - name: Check Allure version
        run: |
          allure --version

      # Run selected test runner based on user input
      - name: Run selected test runner
        shell: pwsh
        run: |
          $runner = "${{ github.event.inputs.runner }}"

          switch ($runner) {
            "ALL-LOBS"    { Set-Location "Src\Regression\Run_all_LOBs"; python Execute_All_LOB.py }
            "AE"          { Set-Location "Src\Regression\AE"; python AE_Execution.py }
            "BR"          { Set-Location "Src\Regression\BR"; python BR_Execution.py }
            "CE"          { Set-Location "Src\Regression\CE"; python CE_Execution.py }
            "Cyber"       { Set-Location "Src\Regression\Cyber"; python Cyber_Execution.py }
            "IA"          { Set-Location "Src\Regression\IA"; python IA_Execution.py }
            "KNR"         { Set-Location "Src\Regression\KNR"; python KNR_Execution.py }
            "MGMT-LIAB"   { Set-Location "Src\Regression\MGMT-LIAB"; python ML_NFP_PNB_Execution.py }
            "ML-PRIVATE"  { Set-Location "Src\Regression\ML-PRIVATE"; python ML_Private_Execution.py }
            "Raven"       { Set-Location "Src\Regression\Raven"; python Raven_Execution.py }
            "RE"          { Set-Location "Src\Regression\RE"; python RE_Execution.py }
            "StorageTank" { Set-Location "Src\Regression\StorageTank"; python ST_Execution.py }
          
            "Alternus" {
                Set-Location "Src\Regression\Alternus"
                robot `
                  --listener "allure_robotframework;..\Run_all_LOBs\allure-results" `
                  --outputdir ..\Run_all_LOBs `
                  .
            }

            "TMS" {
                Set-Location "Src\Regression\TMS"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            "TMS-BR" {
                Set-Location "Src\Regression\TMS\TMS_BR"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            "TMS-Cyber" {
                Set-Location "Src\Regression\TMS\TMS_CYBER"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            "TMS-MGMT-Non-Profit" {
                Set-Location "Src\Regression\TMS\TMS_MGMT_NON_PROFIT"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            "TMS-MGMT-Pvt" {
                Set-Location "Src\Regression\TMS\TMS_MGMT_PVT"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            "TMS-REO" {
                Set-Location "Src\Regression\TMS_REO"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

             "TMS-SAE" {
                Set-Location "Src\Regression\TMS_SAE"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            "UW-RE" {
                Set-Location "Src\Regression\UW\RE"
                robot `
                  --listener allure_robotframework;..\Run_all_LOBs\allure-results `
                  --outputdir Src\Regression\Run_all_LOBs `
                  .
            }

            default       { Write-Error "Invalid runner selection"; exit 1 }
          }

      # Generate Allure HTML report (points to ALL runner output folder; adjust if per-LOB outputs differ)
      - name: Generate Allure Report
        if: always()
        run: |
          allure generate Src\Regression\Run_all_LOBs\allure-results -o allure-report --clean

      - name: Upload Allure Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report